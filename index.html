<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Modernized Control Panel - All Tabs</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/remixicon@4.2.0/fonts/remixicon.css" rel="stylesheet">
    <style>
        /* Global Styles & Color Variables */
        :root {
            --bg-primary: #1a1f2e;
            --bg-secondary: #252b3d;
            --bg-tertiary: #1d2231;
            --text-primary: #e8ecf4;
            --text-secondary: #a0a8c0;
            --accent-primary: #4d7cff;
            --accent-secondary: #222433;
            --accent-primary-text: #ffffff;
            --border-color: #3a4255;
            --shadow-color: rgba(0, 0, 0, 0.4);
            --danger-color: #ff5a7a;
            --success-color: #4af0b0;
        }
        
        /* Theme: Dark Mode */
        [data-theme="dark-mode"] {
            --bg-primary: #1f2128;
            --bg-secondary: #2c2f3a;
            --bg-tertiary: #3a3e4c;
            --text-primary: #e0e2e8;
            --text-secondary: #9da1b0;
            --accent-primary: #4d7cff;
            --accent-secondary: #23253a;
            --accent-primary-text: #ffffff;
            --border-color: #4b4f60;
            --shadow-color: rgba(0, 0, 0, 0.3);
            --danger-color: #ff4a68;
            --success-color: #3ef0a0;
        }
        
        /* Theme: Light Mode */
        [data-theme="light-mode"] {
            --bg-primary: #ffffff;
            --bg-secondary: #f8f9fa;
            --bg-tertiary: #e9ecef;
            --text-primary: #212529;
            --text-secondary: #6c757d;
            --accent-primary: #2196f3;
            --accent-secondary: #e3f2fd;
            --accent-primary-text: #000000;
            --border-color: #dee2e6;
            --shadow-color: rgba(0, 0, 0, 0.1);
            --danger-color: #dc3545;
            --success-color: #28a745;
        }
        
        /* Theme: Legacy */
        [data-theme="legacy"] {
            --bg-primary: #a88f9b;
            --bg-secondary: #a8949e;
            --bg-tertiary: #fffaf8;
            --text-primary: #100e0f;
            --text-secondary: #302a2c;
            --accent-primary: #69525c;
            --accent-secondary: #947181;
            --accent-primary-text: #100e0f;
            --border-color: #614954;
            --shadow-color: rgba(0, 0, 0, 0.4);
            --danger-color: #ff5a6b;
            --success-color: #f0a05a;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: 'Inter', sans-serif;
            /* background-image: url('https://i.imgur.com/W6B7T29.jpeg'); // background image is randomized on page load */
            background-size: cover;
            background-position: center;
            color: var(--text-primary);
            min-height: 100vh;
            transition: background-size 0.3s ease, background-position 0.3s ease;
        }
        
        .panel-wrapper {
            position: absolute;
            top: 2rem;
            left: 2rem;
            width: 500px;
            background: rgba(26, 31, 46, 0.85);
            backdrop-filter: blur(12px);
            border-radius: 12px;
            box-shadow: 0 10px 30px var(--shadow-color);
            border: 1px solid var(--border-color);
            overflow: hidden;
            display: flex;
            flex-direction: column;
            transition: all 0.3s ease;
        }
        
        .panel-wrapper.collapsed {
            width: 48px;
            height: 48px;
            border-radius: 6px;
            position: fixed !important;
            top: 2em !important;
            left: 2em !important;
            z-index: 10000;
        }
        
        .panel-wrapper.collapsed .drag-handle {
            height: 48px;
            padding: 0;
            justify-content: center;
            cursor: pointer;
            border-bottom: none;
        }
        
        .panel-wrapper.collapsed .drag-handle .left-controls,
        .panel-wrapper.collapsed .drag-handle .right-controls {
            display: none;
        }
        
        .panel-wrapper.collapsed .panel-nav,
        .panel-wrapper.collapsed .panel-content,
        .panel-wrapper.collapsed .panel-footer {
            display: none;
        }
        
        .panel-wrapper.collapsed .visibility-toggle {
            display: flex !important;
        }
        
        /* Sidebar mode - attached to left side */
        .panel-wrapper.sidebar-mode {
            position: fixed !important;
            top: 0 !important;
            left: 0 !important;
            height: 100vh !important;
            width: 500px;
            border-radius: 0;
            border-right: 1px solid var(--border-color);
            z-index: 10000;
            display: flex;
            flex-direction: column;
        }
        
        .panel-wrapper.sidebar-mode .panel-content {
            flex: 1;
            overflow-y: auto;
        }
        
        .panel-wrapper.sidebar-mode .panel-footer {
            flex-shrink: 0;
            margin-top: auto;
        }
        
        .panel-wrapper.sidebar-mode .drag-handle {
            cursor: default;
        }
        
        .panel-wrapper.sidebar-mode .drag-handle .left-controls {
            display: flex;
        }
        
        /* Mobile view - bottom half sidebar */
        @media (max-width: 768px) {
            .panel-wrapper {
                position: fixed !important;
                top: auto !important;
                bottom: 0 !important;
                left: 0 !important;
                width: 100vw !important;
                height: 50vh !important;
                border-radius: 12px 12px 0 0;
                z-index: 10000;
                display: flex;
                flex-direction: column;
            }
            
            .panel-wrapper .panel-content {
                flex: 1;
                overflow-y: auto;
            }
            
            .panel-wrapper .panel-footer {
                flex-shrink: 0;
            }
            
            .panel-content .panel-footer {
                margin-top: 16px;
                border-top: 1px solid var(--border-color);
            }
            
            .panel-wrapper.collapsed {
                width: 48px !important;
                height: 48px !important;
                border-radius: 6px !important;
                top: 2em !important;
                left: 2em !important;
                bottom: auto !important;
                z-index: 10000;
            }
        }

        
        .global-tooltip {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: var(--bg-primary);
            backdrop-filter: blur(12px);
            color: var(--text-primary);
            padding: 8px 16px;
            border-radius: 6px;
            font-size: 0.85rem;
            z-index: 9999;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.2s ease;
            box-shadow: 0 4px 12px var(--shadow-color);
            max-width: 300px;
            text-align: center;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        
        .global-tooltip.visible {
            opacity: 1;
        }
        
        .global-tooltip i {
            font-size: 14px;
            color: var(--accent-primary);
        }

        .drag-handle {
            width: 100%;
            height: 32px;
            background: var(--bg-secondary);
            cursor: move;
            position: relative;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 12px;
        }
        
        .drag-handle::before {
            content: "Azgaar Fantasy Map Generator";
            position: absolute;
            left: 50%;
            top: 50%;
            transform: translate(-50%, -50%);
            color: var(--text-secondary);
            font-size: 0.75rem;
            padding: 2px 8px;
            border-radius: 4px;
            white-space: nowrap;
            z-index: 1;
        }
        
        .panel-wrapper.collapsed .drag-handle::before {
            display: none;
        }
        
        .drag-handle .left-controls {
            display: flex;
            align-items: center;
            gap: 6px;
        }
        
        .drag-handle .right-controls {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .drag-handle .sidebar-btn,
        .drag-handle .search-btn,
        .drag-handle .tooltip-toggle-btn,
        .drag-handle .visibility-toggle {
            background: none;
            border: none;
            color: var(--text-secondary);
            cursor: pointer;
            padding: 4px;
            border-radius: 4px;
            transition: color 0.2s ease, background-color 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .drag-handle .sidebar-btn:hover,
        .drag-handle .search-btn:hover,
        .drag-handle .tooltip-toggle-btn:hover,
        .drag-handle .visibility-toggle:hover {
            color: var(--text-primary);
            background: var(--bg-tertiary);
        }
        
        .drag-handle .sidebar-btn i,
        .drag-handle .tooltip-toggle-btn i,
        .drag-handle .visibility-toggle i {
            font-size: 16px;
        }
        
        .drag-handle .search-btn svg {
            width: 16px;
            height: 16px;
        }
        
        .drag-handle .controls-separator {
            color: var(--text-secondary);
            font-size: 14px;
            margin: 0 2px;
        }
        
        .visibility-toggle {
            display: none;
        }
        
        .panel-nav {
            display: flex;
            flex-wrap: wrap;
            border-bottom: 1px solid var(--border-color);
            background: var(--bg-primary);
        }

        .panel-nav-item {
            padding: 14px 18px;
            font-weight: 500;
            cursor: pointer;
            color: var(--text-secondary);
            transition: color 0.2s ease, background-color 0.2s ease;
            position: relative;
            border: none;
            background: none;
            font-size: 1rem;
            flex-grow: 1;
            text-align: center;
        }

        .panel-nav-item:hover { color: var(--text-primary); }
        .panel-nav-item.active { color: var(--text-primary); }
        .panel-nav-item.active::after {
            content: ''; position: absolute; bottom: -1px; left: 0;
            width: 100%; height: 2px; background-color: var(--accent-primary);
        }

        .panel-content {
            padding: 20px; display: flex; flex-direction: column; gap: 28px;
            overflow-y: auto; max-height: calc(90vh - 120px);
        }
        .tab-pane { display: none; flex-direction: column; gap: 28px; }
        .tab-pane.active { display: flex; }

        .panel-section { display: flex; flex-direction: column; gap: 14px; }
        .section-title { font-size: 1rem; font-weight: 600; color: var(--text-primary); display: flex; align-items: center; justify-content: space-between; }
        
        .layer-sort-btn {
            background: transparent;
            border: none;
            color: var(--text-secondary);
            cursor: pointer;
            padding: 4px;
            border-radius: 4px;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .layer-sort-btn:hover {
            color: var(--text-primary);
            background: var(--accent-primary);
        }
        
        .layer-sort-btn i {
            font-size: 16px;
            transition: transform 0.1s ease;
        }
        
        .layer-sort-btn.sorting i {
            animation: sortToggle 0.1s ease-out;
        }
        
        @keyframes sortToggle {
            0% { transform: rotate(0deg); }
            50% { transform: rotate(-15deg); }
            100% { transform: rotate(0deg); }
        }
        
        label, .label-text { font-size: 0.9rem; font-weight: 500; color: var(--text-secondary); display: flex; align-items: center; gap: 8px;}
        .help-text { font-size: 0.8rem; color: var(--text-secondary); text-align: center; font-style: italic; margin-top: 4px; }
        
        .save-preset-btn {
            background: none;
            border: 2px dashed var(--border-color);
            color: var(--text-secondary);
            font-family: 'Inter', sans-serif;
            font-size: 0.9rem;
            font-weight: 500;
            padding: 10px 15px;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            width: 100%;
        }
        
        .save-preset-btn:hover {
            border-color: var(--accent-primary);
            color: var(--text-primary);
        }
        
        .save-preset-btn i {
            font-size: 16px;
        }
        
        .save-preset-input {
            display: none;
            align-items: center;
            gap: 8px;
            width: 100%;
        }
        
        .save-preset-input input {
            flex: 1;
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            border-radius: 4px;
            color: var(--text-primary);
            font-family: 'Inter', sans-serif;
            font-size: 0.9rem;
            padding: 8px 12px;
        }
        
        .save-preset-input .action-btn {
            background: var(--bg-secondary);
            border: none;
            color: var(--text-primary);
            padding: 8px;
            border-radius: 4px;
            cursor: pointer;
            transition: background-color 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .save-preset-input .action-btn:hover {
            background: var(--accent-primary);
        }
        
        .save-preset-input .cancel-btn:hover {
            background: var(--danger-color);
        }
        
        .toggle-container {
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        
        .toggle-container label {
            font-size: 0.9rem;
            font-weight: 500;
            color: var(--text-secondary);
            margin: 0;
            flex: 1;
        }
        
        .toggle-switch {
            position: relative;
            width: 44px;
            height: 24px;
            background: var(--bg-tertiary);
            border-radius: 12px;
            cursor: pointer;
            transition: background-color 0.2s ease;
            flex-shrink: 0;
        }
        
        .toggle-switch.active {
            background: var(--accent-primary);
        }
        
        .toggle-switch::after {
            content: '';
            position: absolute;
            top: 2px;
            left: 2px;
            width: 20px;
            height: 20px;
            background: var(--text-primary);
            border-radius: 50%;
            transition: transform 0.2s ease;
        }
        
        .toggle-switch.active::after {
            transform: translateX(20px);
        }
        
        .info-text { 
            font-size: 0.85rem; 
            color: var(--text-secondary); 
            font-style: italic; 
            text-align: center;
        }

        .input-group { display: flex; gap: 8px; align-items: center; }
        .input-group input { flex-grow: 1; width: 80px; }
        .input-group .icon-btn {
            background: var(--bg-secondary); border: none; padding: 8px;
            border-radius: 6px; cursor: pointer; display: grid; place-items: center; order: 4;
        }
        .input-group .icon-btn:hover { 
            background: var(--accent-primary); 
        }
        .input-group .icon-btn svg { width: 16px; height: 16px; fill: var(--text-primary); }
        
        /* Updated input-group with dropdown order: Prefix, Label, Previous, Dropdown, Next */
        .input-group.dropdown-nav {
            display: flex;
            align-items: center;
            gap: 1px;
        }
        
        .input-group.dropdown-nav .slider-prefix-icon {
            order: 0;
            flex-shrink: 0;
        }
        
        .input-group.dropdown-nav label {
            order: 1;
            flex-basis: 120px;
            flex-shrink: 0;
            font-size: 0.9rem;
            margin-right: auto;
        }
        
        .input-group.dropdown-nav .preset-nav-btn:first-of-type {
            order: 4;
            flex-shrink: 0;
        }
        
        .input-group.dropdown-nav .select-wrapper {
            order: 3;
            flex-grow: 1;
        }
        
        .input-group.dropdown-nav .preset-nav-btn:last-of-type {
            order: 4;
            flex-shrink: 0;
        }
        
        .input-group.dropdown-nav .dice-btn {
            order: 5;
            flex-shrink: 0;
        }
        
        .dice-btn {
            position: relative;
            background: var(--bg-secondary);
            border: none;
            padding: 8px;
            border-radius: 6px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background-color 0.2s ease;
            width: 42px;
            height: 42px;
            flex-shrink: 0;
        }
        
        .dice-btn:hover {
            background: var(--accent-primary);
        }
        
        .dice-btn i {
            font-size: 16px;
            color: var(--text-primary);
        }
        
        .dice-btn.rolling i {
            animation: rollDice 0.3s ease-out;
        }
        
        @keyframes rollDice {
            0% {
                transform: translateY(0) rotate(0deg);
            }
            50% {
                transform: translateY(-10px) rotate(180deg);
            }
            100% {
                transform: translateY(0) rotate(360deg);
            }
        }
        
        .preset-nav-btn {
            height: 42px !important;
            width: 42px;
            color: var(--text-primary) !important;
        }
        
        .preset-nav-btn i {
            font-size: 18px;
            color: var(--text-primary);
        }

        .select-wrapper { position: relative; flex-grow: 1; }
        select {
            width: 100%; 
            padding: 10px 15px; 
            background: var(--bg-secondary);
            border: 1px solid var(--border-color); 
            border-radius: 6px;
            color: var(--text-primary); 
            font-family: 'Inter', sans-serif; 
            font-size: 1rem;
        }
        
        input[type="text"] {
            width: 100%; 
            padding: 10px 15px; 
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color); 
            border-radius: 6px;
            color: var(--text-primary); 
            font-family: 'Inter', sans-serif; 
            font-size: 1rem;
        }
        
        .footer-btn.full-width {
            flex: 1;
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            padding: 10px 12px;
            border-radius: 6px;
            font-weight: 500;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            position: relative;
            font-family: 'Inter', sans-serif;
            color: var(--text-secondary);
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .footer-btn.full-width:hover {
            background: var(--bg-tertiary);
            border-color: var(--accent-primary);
            color: var(--text-primary);
        }
        
        .footer-btn.full-width i {
            font-size: 16px;
        }
        
        input[type="text"].input-narrow {
            width: 80px;
            flex-grow: 0;
            flex-shrink: 0;
        }
        
        input[type="color"] {
            width: 50px;
            height: 24px;
            padding: 0;
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            border-radius: 6px;
            cursor: pointer;
            flex-grow: 0;
            flex-shrink: 0;
        }

        .slider-container { 
            display: flex; 
            align-items: center; 
        }
        
        .slider-prefix-icon {
            width: 24px;
            height: 24px;
            background: var(--bg-secondary);
            border: none;
            border-radius: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: background-color 0.2s ease;
            flex-shrink: 0;
        }
        
        .slider-prefix-icon:hover {
            background: var(--accent-primary);
        }
        
        .slider-prefix-icon i {
            font-size: 14px;
            color: var(--text-primary);
            transition: transform 0.1s ease;
        }
        
        .slider-prefix-icon.lock-toggle i {
            transform-origin: center;
        }
        
        .slider-prefix-icon.lock-toggle.animating i {
            animation: lockToggle 0.1s ease-out;
        }
        
        @keyframes lockToggle {
            0% {
                transform: rotate(0deg);
            }
            50% {
                transform: rotate(-20deg);
            }
            100% {
                transform: rotate(0deg);
            }
        }
        
        .slider-prefix-icon.empty {
            width: 24px;
            background: transparent;
            cursor: default;
        }
        
        .slider-prefix-icon.empty:hover {
            background: transparent;
        }
        
        .slider-container label { 
            flex-basis: 120px; 
            flex-shrink: 0; 
            font-size: 0.9rem; 
            font-weight: 500; 
            color: var(--text-secondary); 
        }
        
        .slider-container .slider-value { 
            font-size: 0.9rem; 
            color: var(--text-primary); 
            min-width: 50px; 
            text-align: right; 
            padding: 2px 6px;
            border-radius: 3px;
            cursor: text;
            transition: border-color 0.2s ease;
            border: 1px solid transparent;
        }
        
        .slider-container .slider-value:hover {
            border-color: var(--border-color);
        }
        
        .slider-container .slider-value:focus {
            outline: none;
            border-color: var(--accent-primary);
            background: var(--bg-secondary);
        }
        
        input[type="range"] {
            -webkit-appearance: none; appearance: none;
            width: 100%; height: 4px; background: var(--bg-tertiary);
            border-radius: 2px; cursor: pointer;
            background: linear-gradient(to right, var(--accent-primary) 0%, var(--accent-primary) 50%, var(--accent-secondary) 50%, var(--accent-secondary) 100%);
        }
        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none; appearance: none;
            width: 16px; height: 16px; background: var(--accent-primary);
            border-radius: 50%; border: 2px solid var(--bg-primary);
            transition: background-color 0.2s;
        }
        input[type="range"]::-moz-range-thumb {
            width: 16px; height: 16px; background: var(--accent-primary);
            border-radius: 50%; border: 2px solid var(--bg-primary);
            transition: background-color 0.2s;
        }
        input[type="range"]:hover::-webkit-slider-thumb { background-color: var(--accent-primary-text); }
        input[type="range"]:hover::-moz-range-thumb { background-color: var(--accent-primary-text); }

        .grid-3-col { display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; }
        .grid-2-col { display: grid; grid-template-columns: repeat(2, 1fr); gap: 8px; }
        .btn {
            padding: 10px; background: var(--bg-secondary); border: 1px solid var(--border-color);
            border-radius: 6px; color: var(--text-secondary); font-family: 'Inter', sans-serif;
            font-size: 0.95rem; font-weight: 500; cursor: pointer; transition: all 0.2s ease;
            text-align: center;
        }
        .btn:hover { 
            background: var(--accent-secondary); 
            color: var(--accent-primary-text); 
            border: 1px solid var(--accent-primary); 
        }
        .btn.active { background: var(--accent-secondary); color: var(--accent-primary-text); border: 1px solid var(--accent-primary); }
        
        /* Multi-toggle buttons styling for layer grids */
        #layer-grid .btn:not(.active) {
            border: 2px dashed var(--accent-secondary);
        }

        #layer-grid .btn.dragging {
            opacity: 0.5;
            transform: scale(1.05);
            z-index: 1000;
            position: relative;
        }
        
        .btn.danger-variant {
            border: 1px solid var(--danger-color);
        }
        
        .btn.danger-variant:hover {
            background: var(--danger-color);
            color: var(--text-primary);
        }
        
        .connected-btn-group {
            display: flex;
            width: 100%;
        }
        
        .connected-btn-group .btn {
            flex: 1;
            border-radius: 0;
            border-right: 1px solid var(--border-color);
        }
        
        .connected-btn-group .btn:first-child {
            border-top-left-radius: 20px;
            border-bottom-left-radius: 20px;
        }
        
        .connected-btn-group .btn:last-child {
            border-top-right-radius: 20px;
            border-bottom-right-radius: 20px;
            border-right: none;
        }
        
        .connected-btn-group .btn:hover {
            background: var(--accent-secondary);
            color: var(--accent-primary-text);
            border: 1px solid var(--accent-primary);
            z-index: 1;
            position: relative;
        }
        
        .connected-btn-group .btn.active {
            background: var(--accent-secondary);
            color: var(--accent-primary-text);
            border: 1px solid var(--accent-primary);
            z-index: 1;
            position: relative;
        }
        .btn-cta {
            background: var(--accent-secondary); 
            color: var(--accent-primary-text); 
            font-weight: 600;
            display: flex; 
            align-items: center; 
            justify-content: center; 
            gap: 8px;
            padding: 10px 16px;
            border: none;
            text-decoration: none;
        }
        .btn-cta:hover { 
            background: var(--accent-primary); 
            border: 0px;
            text-decoration: none !important;
        }

        .about-content p { color: var(--text-secondary); line-height: 1.6; margin-bottom: 1em; }
        .about-content a { color: var(--accent-primary); text-decoration: none; font-weight: 500; }
        .about-content a:hover { text-decoration: underline; }
        .about-content ul { list-style: none; margin-left: 10px; }
        .about-content li { margin-bottom: 0.5em; color: var(--text-secondary); }
        .about-content li::before { content: "•"; color: var(--accent-primary); font-weight: bold; display: inline-block; width: 1em; margin-left: -1em;}
        .social-links { display: flex; gap: 16px; justify-content: center; margin-top: 20px;}
        .social-links a svg { width: 24px; height: 24px; fill: var(--text-secondary); transition: fill 0.2s; }
        .social-links a:hover svg { fill: var(--text-primary); }

        .panel-footer {
            padding: 12px 24px; background: var(--bg-primary); border-top: 1px solid var(--border-color);
            display: flex; flex-direction: column; gap: 8px;
        }
        
        .footer-row {
            display: flex; gap: 8px; justify-content: space-between;
        }
        
        .footer-row:first-child {
            justify-content: center;
        }
        
        .footer-btn {
            background: none; border: none; color: var(--text-secondary); font-family: 'Inter', sans-serif;
            font-weight: 500; padding: 8px 10px; border-radius: 4px; cursor: pointer; transition: all 0.2s ease;
        }
        .footer-btn:hover { background: var(--bg-secondary); color: var(--text-primary); }
        
        .footer-btn.square {
            width: 42px;
            height: 42px;
            flex: none;
            padding: 8px;
            justify-content: center;
        }
        
        .render-priority-container {
            display: flex;
            align-items: center;
        }
        
        .render-priority-container label {
            flex-basis: 120px;
            flex-shrink: 0;
            font-size: 0.9rem;
            font-weight: 500;
            color: var(--text-secondary);
        }
        
        .render-priority-container .connected-btn-group {
            flex-grow: 1;
        }
        
        .section-action-btn {
            background: transparent;
            border: none;
            color: var(--text-secondary);
            cursor: pointer;
            padding: 4px;
            border-radius: 4px;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .section-action-btn:hover {
            color: var(--text-primary);
            background: var(--accent-primary);
        }
        
        .section-action-btn i {
            font-size: 16px;
        }
        
        .section-action-btn.toggled {
            border: 1px solid var(--accent-primary);
            color: var(--text-primary);
        }

        .demo-banner {
            position: fixed;
            top: 1rem;
            right: 1rem;
            color: var(--text-primary);
            padding: 8px 12px;
            border-radius: 6px;
            font-size: 0.85rem;
            font-weight: 500;
            display: block;
            text-align: center;
            z-index: 10001;
            text-decoration: none;
        }

        .panel-wrapper.collapsed #hide-panel-btn {
            display: none !important;
        }

        .fit-to-screen-toggle {
            border: 1px solid transparent;
            transition: border-color 0.2s;
            width: 32px;
            height: 32px;
            background: transparent;
            padding: 10px;
            border-radius: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .fit-to-screen-toggle.toggled {
            border: 1px solid var(--accent-primary);
        }
    </style>
</head>
<body>
    <div class="global-tooltip" id="globalTooltip">
        <i class="ri-information-line"></i>
        <span id="tooltipText"></span>
    </div>

    <a href="https://github.com/LandoNikko/Fantasy-Map-Generator" target="_blank" class="demo-banner">
        <span>This is a prototype demo</span>
        <br>
        <i class="ri-github-fill"></i>
        <span>GitHub</span>
    </a>

    <div class="panel-wrapper" id="control-panel">
        <div class="drag-handle" id="drag-handle">
            <button class="visibility-toggle" id="visibility-toggle" title="Show Panel" data-tooltip="true" style="display: none;">
                <i class="ri-eye-line"></i>
            </button>
            <div class="left-controls">
                <button class="sidebar-btn" id="hide-panel-btn" title="Hide Panel" data-tooltip="true">
                    <i class="ri-eye-off-line"></i>
                </button>
                <span class="controls-separator">|</span>
                <button class="sidebar-btn" id="toggle-sidebar-btn" title="Toggle Sidebar" data-tooltip="true">
                    <i class="ri-sidebar-unfold-fill"></i>
                </button>
            </div>
            <div class="right-controls">
                <button class="tooltip-toggle-btn" id="tooltip-toggle" title="Toggle Tooltips" data-tooltip="true">
                    <i class="ri-information-off-line"></i>
                </button>
                <button class="search-btn" title="Reset Zoom" data-tooltip="true">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 32 32"><path fill="currentColor" d="M22.448 21A10.855 10.855 0 0 0 25 14A10.99 10.99 0 0 0 6 6.466V2H4v8h8V8H7.332a8.977 8.977 0 1 1-2.1 8h-2.04A11.012 11.012 0 0 0 14 25a10.855 10.855 0 0 0 7-2.552L28.586 30L30 28.586Z"/></svg>
                </button>
            </div>
        </div>

        <nav class="panel-nav">
            <button class="panel-nav-item active" data-target="tab-layers" data-tooltip="true">Layers</button>
            <button class="panel-nav-item" data-target="tab-style" data-tooltip="true">Style</button>
            <button class="panel-nav-item" data-target="tab-options" data-tooltip="true">Options</button>
            <button class="panel-nav-item" data-target="tab-tools" data-tooltip="true">Tools</button>
            <button class="panel-nav-item" data-target="tab-about" data-tooltip="true">About</button>
        </nav>

        <main class="panel-content">
            
            <div class="tab-pane active" id="tab-layers">
                <div class="panel-section">
                    <h2 class="section-title" data-tooltip="true">Layers preset</h2>
                    <div class="input-group">
                        <button class="icon-btn preset-nav-btn" id="preset-prev" title="Previous preset" data-tooltip="true">
                            <i class="ri-arrow-left-line"></i>
                        </button>
                        <div class="select-wrapper">
                            <select id="layers-preset" data-tooltip="true">
                                <option>Political map</option>
                                <option>Cultural map</option>
                                <option>Religions map</option>
                                <option>Provinces map</option>
                                <option>Biomes map</option>
                                <option>Heightmap</option>
                                <option>Physical map</option>
                                <option>Places of interest</option>
                                <option>Military map</option>
                                <option>Emblems</option>
                                <option>Pure landmass</option>
                            </select>
                        </div>
                        <button class="icon-btn preset-nav-btn" id="preset-next" title="Next preset" data-tooltip="true">
                            <i class="ri-arrow-right-line"></i>
                        </button>
                    </div>
                </div>
                <div class="panel-section">
                    <h2 class="section-title" data-tooltip="true">
                        Displayed Layers and Layers order
                        <button class="layer-sort-btn" id="layer-sort-toggle" title="Toggle layer sorting" data-tooltip="true">
                            <i class="ri-sort-desc"></i>
                        </button>
                    </h2>
                    <div class="grid-3-col" id="layer-grid">
                        <button class="btn" data-tooltip="true">Texture</button><button class="btn" data-tooltip="true">Heightmap</button><button class="btn" data-tooltip="true">Biomes</button>
                        <button class="btn" data-tooltip="true">Cells</button><button class="btn" data-tooltip="true">Grid</button><button class="btn" data-tooltip="true">Coordinates</button>
                        <button class="btn" data-tooltip="true">Wind Rose</button><button class="btn active" data-tooltip="true">Rivers</button><button class="btn" data-tooltip="true">Relief</button>
                        <button class="btn" data-tooltip="true">Religions</button><button class="btn" data-tooltip="true">Cultures</button><button class="btn active" data-tooltip="true">States</button>
                        <button class="btn" data-tooltip="true">Provinces</button><button class="btn" data-tooltip="true">Zones</button><button class="btn active" data-tooltip="true">Borders</button>
                        <button class="btn active" data-tooltip="true">Routes</button><button class="btn" data-tooltip="true">Temperature</button><button class="btn" data-tooltip="true">Population</button>
                        <button class="btn active" data-tooltip="true">Ice</button><button class="btn" data-tooltip="true">Precipitation</button><button class="btn" data-tooltip="true">Emblems</button>
                        <button class="btn active" data-tooltip="true">Labels</button><button class="btn active" data-tooltip="true">Icons</button><button class="btn" data-tooltip="true">Military</button>
                        <button class="btn" data-tooltip="true">Markers</button><button class="btn" data-tooltip="true">Rulers</button><button class="btn active" data-tooltip="true">Scale Bar</button>
                    </div>
                    <button class="save-preset-btn" id="save-preset-btn" style="display: none;" data-tooltip="true">
                        <i class="ri-add-circle-line"></i>
                        Save Preset
                    </button>
                    <div class="save-preset-input" id="save-preset-input">
                        <input type="text" placeholder="Enter preset name..." id="preset-name-input" data-tooltip="true">
                        <button class="action-btn" id="save-preset-confirm" title="Save" data-tooltip="true">
                            <i class="ri-check-line"></i>
                        </button>
                        <button class="action-btn cancel-btn" id="save-preset-cancel" title="Cancel" data-tooltip="true">
                            <i class="ri-close-line"></i>
                        </button>
                    </div>
                </div>
                <div class="panel-section">
                    <h2 class="section-title" data-tooltip="true">View mode</h2>
                    <div class="connected-btn-group" data-toggle-group="view-mode">
                        <button class="btn active" data-tooltip="true">Standard</button>
                        <button class="btn" data-tooltip="true">3D scene</button>
                        <button class="btn" data-tooltip="true">Globe</button>
                    </div>
                </div>
            </div>

            <div class="tab-pane" id="tab-style">
                <div class="panel-section">
                    <h3 class="section-title" data-tooltip="true">
                        Style preset
                        <button class="section-action-btn" title="Download Style" data-tooltip="true">
                            <i class="ri-file-download-line"></i>
                        </button>
                    </h3>
                    <div class="input-group dropdown-nav">
                        <div class="slider-prefix-icon empty"></div>
                        <label data-tooltip="true">Style preset</label>
                        <button class="icon-btn preset-nav-btn" id="style-prev" title="Previous style" data-tooltip="true">
                            <i class="ri-arrow-left-line"></i>
                        </button>
                        <div class="select-wrapper">
                            <select id="style-preset" data-tooltip="true">
                                <option>Default</option>
                                <option>Ancient</option>
                                <option>Gloom</option>
                                <option>Pale</option>
                                <option>Light</option>
                                <option>Watercolor</option>
                                <option>Clean</option>
                                <option>Atlas</option>
                                <option>DarkSeas</option>
                                <option>Cyberpunk</option>
                                <option>Night</option>
                                <option>Monochrome</option>
                            </select>
                        </div>
                        <button class="icon-btn preset-nav-btn" id="style-next" title="Next style" data-tooltip="true">
                            <i class="ri-arrow-right-line"></i>
                        </button>
                    </div>
                </div>
                <div class="panel-section">
                    <h3 class="section-title" data-tooltip="true">Select element</h3>
                    <div class="input-group dropdown-nav">
                        <div class="slider-prefix-icon empty"></div>
                        <label data-tooltip="true">Select element</label>
                        <button class="icon-btn preset-nav-btn" id="element-prev" title="Previous element" data-tooltip="true">
                            <i class="ri-arrow-left-line"></i>
                        </button>
                        <div class="select-wrapper">
                            <select id="select-element" data-tooltip="true">
                                <option>Anchor Icons</option>
                                <option>Biomes</option>
                                <option>Borders</option>
                                <option>Burg Icons</option>
                                <option>Cells</option>
                                <option>Coastline</option>
                                <option>Coordinates</option>
                                <option>Cultures</option>
                                <option>Emblems</option>
                                <option>Fogging</option>
                                <option>Grid</option>
                                <option>Heightmap</option>
                                <option>Ice</option>
                                <option>Labels</option>
                                <option>Lakes</option>
                                <option>Landmass</option>
                                <option>Legend</option>
                                <option>Markers</option>
                                <option>Military</option>
                                <option>Ocean</option>
                                <option>Population</option>
                                <option>Precipitation</option>
                                <option>Provinces</option>
                                <option>Relief Icons</option>
                                <option>Religions</option>
                                <option>Rivers</option>
                                <option>Routes</option>
                                <option>Rulers</option>
                                <option>Scale Bar</option>
                                <option>States</option>
                                <option>Temperature</option>
                                <option>Texture</option>
                                <option>Vignette</option>
                                <option>Wind Rose</option>
                                <option>Zones</option>
                            </select>
                        </div>
                        <button class="icon-btn preset-nav-btn" id="element-next" title="Next element" data-tooltip="true">
                            <i class="ri-arrow-right-line"></i>
                        </button>
                    </div>
                    <div class="slider-container">
                        <div class="slider-prefix-icon empty"></div>
                        <label for="body-opacity" data-tooltip="true">Body opacity</label>
                        <input type="range" id="body-opacity" min="0" max="1" step="0.01" value="0.4" oninput="this.nextElementSibling.textContent = this.value" data-tooltip="true">
                        <span class="slider-value" data-tooltip="true">0.4</span>
                    </div>
                    <div class="input-group dropdown-nav">
                        <div class="slider-prefix-icon empty"></div>
                        <label data-tooltip="true">Body filter</label>
                        <div class="select-wrapper">
                            <select id="body-filter" data-tooltip="true">
                                <option>None</option>
                            </select>
                        </div>
                    </div>
                </div>
                 <div class="panel-section">
                    <p class="info-text" data-tooltip="true">Halo is only rendered if "Rendering" option is set to "Best quality"!</p>
                    <div class="slider-container">
                        <div class="slider-prefix-icon empty"></div>
                        <label for="halo-width" data-tooltip="true">Halo width</label>
                        <input type="range" id="halo-width" min="0" max="20" step="0.1" value="10" oninput="this.nextElementSibling.textContent = this.value" data-tooltip="true">
                        <span class="slider-value" data-tooltip="true">10</span>
                    </div>
                    <div class="slider-container">
                        <div class="slider-prefix-icon empty"></div>
                        <label for="halo-opacity" data-tooltip="true">Halo opacity</label>
                        <input type="range" id="halo-opacity" min="0" max="1" step="0.01" value="0.4" oninput="this.nextElementSibling.textContent = this.value" data-tooltip="true">
                        <span class="slider-value" data-tooltip="true">0.4</span>
                    </div>
                    <div class="slider-container">
                        <div class="slider-prefix-icon empty"></div>
                        <label for="halo-blur" data-tooltip="true">Halo blur</label>
                        <input type="range" id="halo-blur" min="0" max="10" step="0.1" value="3.5" oninput="this.nextElementSibling.textContent = this.value" data-tooltip="true">
                        <span class="slider-value" data-tooltip="true">3.5</span>
                    </div>
                </div>
                <div class="panel-section">
                    <h3 class="section-title" data-tooltip="true">Toggle global filters</h3>
                    <div class="connected-btn-group" data-toggle-group="global-filters">
                        <button class="btn active" data-tooltip="true">None</button>
                        <button class="btn" data-tooltip="true">Grayscale</button>
                        <button class="btn" data-tooltip="true">Sepia</button>
                        <button class="btn" data-tooltip="true">Dingy</button>
                        <button class="btn" data-tooltip="true">Tint</button>
                    </div>
                </div>
                <div class="panel-section">
                    <div class="toggle-container">
                        <div class="slider-prefix-icon empty"></div>
                        <label for="vignette-toggle" data-tooltip="true">Vignette</label>
                        <div class="toggle-switch active" id="vignette-toggle" data-tooltip="true"></div>
                    </div>
                </div>
            </div>

            <div class="tab-pane" id="tab-options">
                <div class="panel-section">
                    <h2 class="section-title" data-tooltip="true">Map settings (new map to apply)</h2>
                    <div class="slider-container">
                        <button class="slider-prefix-icon lock-toggle" data-icon="lock" data-tooltip="true">
                            <i class="ri-lock-unlock-line"></i>
                        </button>
                        <label data-tooltip="true">Canvas size</label>
                        <input type="text" class="input-narrow" value="2560" data-tooltip="true"><span style="color:var(--text-secondary)">x</span><input type="text" class="input-narrow" value="1305" data-tooltip="true"><span style="color:var(--text-secondary)">px</span>
                    </div>
                    <div class="slider-container">
                        <button class="slider-prefix-icon lock-toggle" data-icon="lock" data-tooltip="true">
                            <i class="ri-lock-unlock-line"></i>
                        </button>
                        <label data-tooltip="true">Map seed</label>
                        <input type="text" value="665411328" data-tooltip="true">
                        <button class="dice-btn" id="randomizeSeedBtn" title="Randomize" data-tooltip="true">
                            <i class="ri-dice-fill"></i>
                        </button>
                    </div>
                    <div class="slider-container">
                        <button class="slider-prefix-icon lock-toggle" data-icon="lock" data-tooltip="true">
                            <i class="ri-lock-unlock-line"></i>
                        </button>
                        <label data-tooltip="true">Points number</label>
                        <input type="range" id="points-number" min="1000" max="50000" step="1000" value="10000" oninput="this.nextElementSibling.textContent = this.value+'K'" data-tooltip="true">
                        <span class="slider-value" data-tooltip="true">10K</span>
                    </div>
                    <div class="slider-container">
                        <button class="slider-prefix-icon lock-toggle" data-icon="lock" data-tooltip="true">
                            <i class="ri-lock-unlock-line"></i>
                        </button>
                        <label data-tooltip="true">Map name</label>
                        <input type="text" value="Camia" data-tooltip="true">
                        <button class="dice-btn" id="generateNameBtn" title="Generate Name" data-tooltip="true">
                            <i class="ri-dice-fill"></i>
                        </button>
                    </div>
                    <div class="slider-container">
                        <button class="slider-prefix-icon lock-toggle" data-icon="lock" data-tooltip="true">
                            <i class="ri-lock-unlock-line"></i>
                        </button>
                        <label data-tooltip="true">Year & era</label>
                        <input type="text" class="input-narrow" value="1213" data-tooltip="true">
                        <input type="text" value="Macking Era" data-tooltip="true">
                        <button class="dice-btn" id="randomizeEraBtn" title="Randomize Era" data-tooltip="true">
                            <i class="ri-dice-fill"></i>
                        </button>
                    </div>
                </div>
                <div class="panel-section" style="gap: 18px;">
                     <div class="input-group dropdown-nav">
                         <button class="slider-prefix-icon lock-toggle" data-icon="lock" data-tooltip="true">
                             <i class="ri-lock-unlock-line"></i>
                         </button>
                         <label data-tooltip="true">Heightmap</label>
                         <button class="icon-btn preset-nav-btn" id="heightmap-prev" title="Previous heightmap" data-tooltip="true">
                             <i class="ri-arrow-left-line"></i>
                         </button>
                         <div class="select-wrapper">
                             <select id="heightmap-select" data-tooltip="true">
                                 <option>Continents</option>
                                 <option>Islands</option>
                                 <option>Archipelago</option>
                                 <option>Peninsula</option>
                             </select>
                         </div>
                         <button class="icon-btn preset-nav-btn" id="heightmap-next" title="Next heightmap" data-tooltip="true">
                             <i class="ri-arrow-right-line"></i>
                         </button>
                     </div>
                     <div class="input-group dropdown-nav">
                         <button class="slider-prefix-icon lock-toggle" data-icon="lock" data-tooltip="true">
                             <i class="ri-lock-unlock-line"></i>
                         </button>
                         <label data-tooltip="true">Cultures set</label>
                         <button class="icon-btn preset-nav-btn" id="cultures-prev" title="Previous culture set" data-tooltip="true">
                             <i class="ri-arrow-left-line"></i>
                         </button>
                         <div class="select-wrapper">
                             <select id="cultures-select" data-tooltip="true">
                                 <option>All-world</option>
                                 <option>European</option>
                                 <option>Asian</option>
                                 <option>Fantasy</option>
                             </select>
                         </div>
                         <button class="icon-btn preset-nav-btn" id="cultures-next" title="Next culture set" data-tooltip="true">
                             <i class="ri-arrow-right-line"></i>
                         </button>
                     </div>
                     <div class="slider-container">
                         <div class="slider-prefix-icon empty"></div>
                         <label data-tooltip="true">States</label>
                         <input type="range" id="states-number" min="1" max="50" value="21" data-tooltip="true">
                         <span class="slider-value" data-tooltip="true">21</span>
                     </div>
                     <div class="slider-container">
                         <div class="slider-prefix-icon empty"></div>
                         <label data-tooltip="true">Provinces ratio</label>
                         <input type="range" id="provinces-ratio" min="1" max="50" value="21" data-tooltip="true">
                         <span class="slider-value" data-tooltip="true">21</span>
                     </div>
                     <div class="slider-container">
                         <div class="slider-prefix-icon empty"></div>
                         <label data-tooltip="true">Size variety</label>
                         <input type="range" id="size-variety" min="0" max="10" step="0.1" value="5.4" data-tooltip="true">
                         <span class="slider-value" data-tooltip="true">5.4</span>
                     </div>
                     <div class="slider-container">
                         <div class="slider-prefix-icon empty"></div>
                         <label data-tooltip="true">Growth rate</label>
                         <input type="range" id="growth-rate" min="0.1" max="5" step="0.1" value="1.1" data-tooltip="true">
                         <span class="slider-value" data-tooltip="true">1.1</span>
                     </div>
                     <div class="slider-container">
                         <div class="slider-prefix-icon empty"></div>
                         <label data-tooltip="true">Towns</label>
                         <input type="range" id="towns-number" min="0.1" max="5" step="0.1" value="1.1" data-tooltip="true">
                         <span class="slider-value" data-tooltip="true">1.1</span>
                     </div>
                     <div class="slider-container">
                         <div class="slider-prefix-icon empty"></div>
                         <label data-tooltip="true">Religions</label>
                         <input type="range" id="religions-number" min="1" max="20" value="5" data-tooltip="true">
                         <span class="slider-value" data-tooltip="true">5</span>
                     </div>
                                         <div class="input-group dropdown-nav">
                        <div class="slider-prefix-icon empty"></div>
                        <label data-tooltip="true">State labels</label>
                        <button class="icon-btn preset-nav-btn" id="state-labels-prev" title="Previous state labels mode" data-tooltip="true">
                            <i class="ri-arrow-left-line"></i>
                        </button>
                        <div class="select-wrapper">
                            <select id="state-labels-select" data-tooltip="true">
                                <option>Auto</option>
                                <option>Short names</option>
                                <option>Full names</option>
                            </select>
                        </div>
                        <button class="icon-btn preset-nav-btn" id="state-labels-next" title="Next state labels mode" data-tooltip="true">
                            <i class="ri-arrow-right-line"></i>
                        </button>
                    </div>
                </div>
                <div class="panel-section">
                    <h2 class="section-title" data-tooltip="true">Generator settings</h2>
                    <div class="input-group dropdown-nav">
                        <div class="slider-prefix-icon empty"></div>
                        <label data-tooltip="true">UI Theme</label>
                        <button class="icon-btn preset-nav-btn" id="theme-prev" title="Previous theme" data-tooltip="true">
                            <i class="ri-arrow-left-line"></i>
                        </button>
                        <div class="select-wrapper">
                            <select id="ui-theme" data-tooltip="true">
                                <option>Default</option>
                                <option>Dark Mode</option>
                                <option>Light Mode</option>
                                <option>Legacy</option>
                            </select>
                        </div>
                        <button class="icon-btn preset-nav-btn" id="theme-next" title="Next theme" data-tooltip="true">
                            <i class="ri-arrow-right-line"></i>
                        </button>
                    </div>
                    <div class="slider-container">
                        <div class="slider-prefix-icon empty"></div>
                        <label for="opacity-amount" data-tooltip="true">Panel opacity</label>
                        <input type="range" id="opacity-amount" min="0" max="100" step="5" value="95" data-tooltip="true">
                        <span class="slider-value" data-tooltip="true">95%</span>
                    </div>
                    <div class="slider-container">
                        <div class="slider-prefix-icon empty"></div>
                        <label for="blur-amount" data-tooltip="true">Panel blur</label>
                        <input type="range" id="blur-amount" min="0" max="20" step="1" value="12" data-tooltip="true">
                        <span class="slider-value" data-tooltip="true">12px</span>
                    </div>
                    <div class="slider-container">
                        <div class="slider-prefix-icon empty"></div>
                        <label data-tooltip="true">Interface size</label>
                        <input type="range" id="interface-size" min="1" max="5" value="2" data-tooltip="true">
                        <span class="slider-value" data-tooltip="true">2</span>
                    </div>
                    <div class="slider-container">
                        <div class="slider-prefix-icon empty"></div>
                        <label data-tooltip="true">Tooltip size</label>
                        <input type="range" id="tooltip-size" min="8" max="24" value="14" data-tooltip="true">
                        <span class="slider-value" data-tooltip="true">14</span>
                    </div>
                    <div class="slider-container">
                        <button class="slider-prefix-icon" data-tooltip="true">
                            <i class="ri-loop-left-line"></i>
                        </button>
                        <label data-tooltip="true">Theme color</label>
                        <input type="range" id="theme-color-slider" min="0" max="360" value="90" data-tooltip="true">
                        <input type="color" value="#5a5a5a" data-tooltip="true">
                    </div>
                    <div class="input-group dropdown-nav">
                        <div class="slider-prefix-icon empty"></div>
                        <label data-tooltip="true">Onload behavior</label>
                        <button class="icon-btn preset-nav-btn" id="onload-prev" title="Previous onload behavior" data-tooltip="true">
                            <i class="ri-arrow-left-line"></i>
                        </button>
                        <div class="select-wrapper">
                            <select id="onload-select" data-tooltip="true">
                                <option>Generate random map</option>
                                <option>Open last saved map</option>
                            </select>
                        </div>
                        <button class="icon-btn preset-nav-btn" id="onload-next" title="Next onload behavior" data-tooltip="true">
                            <i class="ri-arrow-right-line"></i>
                        </button>
                    </div>
                    <div class="toggle-container">
                        <div class="slider-prefix-icon empty"></div>
                        <label for="azgaar-toggle" data-tooltip="true">Azgaar assistant</label>
                        <div class="toggle-switch active" id="azgaar-toggle" data-tooltip="true"></div>
                    </div>
                    <div class="input-group dropdown-nav">
                        <button class="slider-prefix-icon" data-tooltip="true">
                            <i class="ri-speak-fill"></i>
                        </button>
                        <label data-tooltip="true">Speaker voice</label>
                        <button class="icon-btn preset-nav-btn" id="voice-prev" title="Previous voice" data-tooltip="true">
                            <i class="ri-arrow-left-line"></i>
                        </button>
                        <div class="select-wrapper">
                            <select id="voice-select" data-tooltip="true">
                                <option>Microsoft David - English (US)</option>
                                <option>Microsoft Zira - English (US)</option>
                                <option>Microsoft Mark - English (US)</option>
                            </select>
                        </div>
                        <button class="icon-btn preset-nav-btn" id="voice-next" title="Next voice" data-tooltip="true">
                            <i class="ri-arrow-right-line"></i>
                        </button>
                    </div>
                    <div class="input-group dropdown-nav">
                        <div class="slider-prefix-icon empty"></div>
                        <label data-tooltip="true">Emblem shape</label>
                        <button class="icon-btn preset-nav-btn" id="emblem-prev" title="Previous emblem shape" data-tooltip="true">
                            <i class="ri-arrow-left-line"></i>
                        </button>
                        <div class="select-wrapper">
                            <select id="emblem-select" data-tooltip="true">
                                <option>Culture-specific</option>
                                <option>Culture-random</option>
                                <option>State-specific</option>
                            </select>
                        </div>
                        <button class="icon-btn preset-nav-btn" id="emblem-next" title="Next emblem shape" data-tooltip="true">
                            <i class="ri-arrow-right-line"></i>
                        </button>
                    </div>
                    <div class="slider-container">
                        <button class="slider-prefix-icon" data-tooltip="true">
                            <i class="ri-loop-left-line"></i>
                        </button>
                        <label data-tooltip="true">Zoom extent</label>
                        <span>min</span>
                        <input type="text" value="1" data-tooltip="true">
                        <span>max</span>
                        <input type="text" value="20" data-tooltip="true">
                        <button class="section-action-btn" id="fitToScreenBtn" title="Fit to screen" data-tooltip="true">
                            <i class="ri-drag-move-line"></i>
                        </button>
                    </div>
                    <div class="render-priority-container">
                        <div class="slider-prefix-icon empty"></div>
                        <label data-tooltip="true">Render priority</label>
                        <div class="connected-btn-group" data-toggle-group="render-priority">
                            <button class="btn" data-tooltip="true">Quality</button>
                            <button class="btn active" data-tooltip="true">Performance</button>
                        </div>
                    </div>
                    <div class="slider-container">
                        <button class="slider-prefix-icon" data-tooltip="true">
                            <i class="ri-loop-left-line"></i>
                        </button>
                        <label data-tooltip="true">Language</label>
                        <button class="btn" style="flex-grow:1;" data-tooltip="true">Init Google Translate</button>
                    </div>
                </div>
                <div class="grid-2-col">
                    <button class="btn" data-tooltip="true">Configure World</button>
                    <button class="btn danger-variant" data-tooltip="true">Reset to defaults</button>
                </div>
            </div>

            <div class="tab-pane" id="tab-tools">
                <div class="panel-section">
                    <h2 class="section-title" data-tooltip="true">Edit</h2>
                    <div class="grid-3-col" id="tools-edit-grid">
                        <button class="btn" data-tooltip="true">Biomes</button><button class="btn" data-tooltip="true">Burgs</button><button class="btn" data-tooltip="true">Cultures</button>
                        <button class="btn" data-tooltip="true">Diplomacy</button><button class="btn" data-tooltip="true">Emblems</button><button class="btn" data-tooltip="true">Heightmap</button>
                        <button class="btn" data-tooltip="true">Markers</button><button class="btn" data-tooltip="true">Military</button><button class="btn" data-tooltip="true">Namesbase</button>
                        <button class="btn" data-tooltip="true">Notes</button><button class="btn" data-tooltip="true">Provinces</button><button class="btn" data-tooltip="true">Religions</button>
                        <button class="btn" data-tooltip="true">Rivers</button><button class="btn" data-tooltip="true">Routes</button><button class="btn" data-tooltip="true">States</button>
                        <button class="btn" data-tooltip="true">Units</button><button class="btn" data-tooltip="true">Zones</button>
                    </div>
                </div>
                <div class="panel-section">
                    <h2 class="section-title" data-tooltip="true">Regenerate</h2>
                    <div class="grid-3-col" id="tools-regenerate-grid">
                        <button class="btn" data-tooltip="true">Burgs</button><button class="btn" data-tooltip="true">Cultures</button><button class="btn" data-tooltip="true">Emblems</button>
                        <button class="btn" data-tooltip="true">Ice</button><button class="btn" data-tooltip="true">State Labels</button><button class="btn" data-tooltip="true">Markers</button>
                        <button class="btn" data-tooltip="true">Military</button><button class="btn" data-tooltip="true">Population</button><button class="btn" data-tooltip="true">Provinces</button>
                        <button class="btn" data-tooltip="true">Relief</button><button class="btn" data-tooltip="true">Religions</button><button class="btn" data-tooltip="true">Rivers</button>
                        <button class="btn" data-tooltip="true">Routes</button><button class="btn" data-tooltip="true">States</button><button class="btn" data-tooltip="true">Zones</button>
                    </div>
                </div>
                <div class="panel-section">
                    <h2 class="section-title" data-tooltip="true">Add</h2>
                    <div class="grid-3-col" id="tools-add-grid">
                        <button class="btn" data-tooltip="true">Burg</button><button class="btn" data-tooltip="true">Label</button><button class="btn" data-tooltip="true">Marker</button>
                        <button class="btn" data-tooltip="true">River</button><button class="btn" data-tooltip="true">Route</button>
                    </div>
                </div>
                 <div class="panel-section">
                    <h2 class="section-title" data-tooltip="true">Show</h2>
                    <div class="grid-2-col" id="tools-show-grid">
                        <button class="btn" data-tooltip="true">Cells</button><button class="btn" data-tooltip="true">Charts</button>
                    </div>
                </div>
                <div class="panel-section">
                    <h2 class="section-title" data-tooltip="true">Create</h2>
                    <div class="grid-2-col" id="tools-create-grid">
                        <button class="btn" data-tooltip="true">Submap</button><button class="btn" data-tooltip="true">Transform</button>
                    </div>
                </div>
            </div>

            <div class="tab-pane about-content" id="tab-about">
                <div class="panel-section">
                    <p data-tooltip="true">
                        <a href="#" data-tooltip="true">Fantasy Map Generator</a> is an <a href="#" data-tooltip="true">open source</a> tool by Azgaar. You may use auto-generated maps as they are, edit them or even create a new map from scratch. Check out the 
                        <a href="#" data-tooltip="true">Quick start</a>, 
                        <a href="#" data-tooltip="true">Q&amp;A</a>, 
                        <a href="#" data-tooltip="true">Video tutorial</a>, 
                        and <a href="#" data-tooltip="true">hotkeys</a> for guidance.
                    </p>
                    <p data-tooltip="true">Join our <a href="#" data-tooltip="true">Discord server</a> and <a href="#" data-tooltip="true">Reddit community</a> to ask questions, get help and share maps. The created maps can be used for free, even for commercial purposes.</p>
                    <p data-tooltip="true">The project is under active development. Creator and main maintainer: Lorem Ipsum. To track the development progress see the <a href="#" data-tooltip="true">devboard</a>. For older versions see the <a href="#" data-tooltip="true">changelog</a>. Please report bugs <a href="#" data-tooltip="true">here</a>. You can also contact me directly via <a href="#" data-tooltip="true">email</a>.</p>
                </div>
                <a href="#" class="btn btn-cta" data-tooltip="true">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"><path fill="currentColor" d="M22.957 7.21c-.004-3.064-2.391-5.576-5.191-6.482c-3.478-1.125-8.064-.962-11.384.604C2.357 3.231 1.093 7.391 1.046 11.54c-.039 3.411.302 12.396 5.369 12.46c3.765.047 4.326-4.804 6.068-7.141c1.24-1.662 2.836-2.132 4.801-2.618c3.376-.836 5.678-3.501 5.673-7.031"/></svg>
                    Support on Patreon
                </a>
                <p data-tooltip="true" style="margin-top: 0.5em;">Special thanks to all supporters on Patreon!</p>
                <div class="panel-section">
                    <h3 class="section-title" style="font-size: 1rem; color: var(--text-primary)" data-tooltip="true">Check out our other projects:</h3>
                    <ul>
                        <li data-tooltip="true"><a href="#" data-tooltip="true">Armoria</a>: a tool for creating heraldic coats of arms</li>
                        <li data-tooltip="true"><a href="#" data-tooltip="true">Deorum</a>: a vast gallery of customizable fantasy characters</li>
                    </ul>
                </div>
                <div class="panel-section">
                    <p data-tooltip="true">Chinese localization: <a href="#" data-tooltip="true">8desk.top</a></p>
                    <div class="social-links">
                        <a href="#" title="Facebook" data-tooltip="true">
                            <i class="ri-facebook-circle-fill social-icon"></i>
                        </a>
                        <a href="#" title="Twitter" data-tooltip="true">
                            <i class="ri-twitter-x-line social-icon"></i>
                        </a>
                        <a href="#" title="Pinterest" data-tooltip="true">
                            <i class="ri-pinterest-fill social-icon"></i>
                        </a>
                        <a href="#" title="Reddit" data-tooltip="true">
                            <i class="ri-reddit-fill social-icon"></i>
                        </a>
                        <a href="#" title="Discord" data-tooltip="true">
                            <i class="ri-discord-fill social-icon"></i>
                        </a>
                    </div>
                    <style>
                        .social-icon {
                            font-size: 24px;
                            width: 24px;
                            height: 24px;
                            display: inline-block;
                            vertical-align: middle;
                        }
                    </style>
                </div>
            </div>

        </main>
        
        <footer class="panel-footer">
            <div class="footer-row">
                <button class="footer-btn full-width square" id="back-btn" data-tooltip="true">
                    <i class="ri-arrow-go-back-line"></i>
                </button>
                <button class="footer-btn full-width dice-btn" id="new-map-btn" data-tooltip="true">
                    <i class="ri-dice-fill"></i>
                    New Map
                </button>
            </div>
            <div class="footer-row">
                <button class="footer-btn full-width" data-tooltip="true">
                    <i class="ri-file-upload-line"></i>
                    Load
                </button>
                <button class="footer-btn full-width" data-tooltip="true">
                    <i class="ri-file-download-line"></i>
                    Save
                </button>
                <button class="footer-btn full-width" data-tooltip="true">
                    <i class="ri-file-transfer-line"></i>
                    Export
                </button>
            </div>
        </footer>
    </div>
    
    <script>
        const DICE_ICON = {
            fill: '<i class="ri-dice-fill"></i>'
        };
        
        // Randomized background images (for New Map button)
        const BACKGROUND_IMAGES = [
            'https://i.imgur.com/W6B7T29.jpeg',
            'https://i.imgur.com/O9bqpqU.jpeg',
            'https://i.imgur.com/KlKUEc6.jpeg',
            'https://i.imgur.com/KQmaw1W.jpeg',
            'https://i.imgur.com/icvg6oJ.jpeg',
            'https://i.imgur.com/bfUFTJE.jpeg'
        ];
        
        const TOOLTIP_MESSAGES = [
            "This is a tooltip for adjusting the setting for a feature.",
            "I am a tooltip for explaining the function of this feature.",
            "I am teaching you about this feature.",
            "This tooltip provides more detail about the option you are hovering on.",
            "Use this to do something that will affect the map.",
            "This feature affects the map in a way that is interesting.",
            "This tooltip explains how to do something.",
            "This is showing you more information about a feature.",
            "This is a tooltip for a feature that will affect the map, but be aware that it may cause the map to become less responsive.",
            "I am a tooltip for additional help and guidance.",
            "This is a very long tooltip designed to provide more context about the feature, helping you to better understand it and, hopefully, use it more effectively.",
        ];
        
        let tooltipsEnabled = localStorage.getItem('tooltipsEnabled') !== 'false'; // Default to true, but respect stored preference
        let isLayerSortedByActive = false;
        let isDragging = false;
        let draggedElement = null;
        
        function createDiceButton(id, title, additionalClasses = '') {
            const button = document.createElement('button');
            button.className = `dice-btn ${additionalClasses}`.trim();
            button.id = id;
            button.title = title;
            button.innerHTML = DICE_ICON.fill;
            return button;
        }
        
        function addDiceAnimation(button) {
            button.addEventListener('click', () => {
                button.classList.add('rolling');
                setTimeout(() => button.classList.remove('rolling'), 300);
            });
        }
        
        function getRandomTooltip() {
            return TOOLTIP_MESSAGES[Math.floor(Math.random() * TOOLTIP_MESSAGES.length)];
        }
        
        function initializeTooltips() {
            const globalTooltip = document.getElementById('globalTooltip');
            const tooltipText = document.getElementById('tooltipText');
            const tooltipElements = document.querySelectorAll('[data-tooltip="true"]');
            
            tooltipElements.forEach(element => {
                element.addEventListener('mouseenter', () => {
                    if (!tooltipsEnabled) return;
                    const message = getRandomTooltip();
                    tooltipText.textContent = message;
                    globalTooltip.classList.add('visible');
                });
                
                element.addEventListener('mouseleave', () => {
                    globalTooltip.classList.remove('visible');
                });
            });
        }
        
        function initializeDragAndDrop() {
            const layerGrid = document.getElementById('layer-grid');
            const buttons = layerGrid.querySelectorAll('.btn');
            
            buttons.forEach(button => {
                button.draggable = true;
                
                button.addEventListener('dragstart', (e) => {
                    draggedElement = button;
                    button.classList.add('dragging');
                    e.dataTransfer.effectAllowed = 'move';
                });
                
                button.addEventListener('dragend', () => {
                    button.classList.remove('dragging');
                    draggedElement = null;
                });
                
                button.addEventListener('dragover', (e) => {
                    e.preventDefault();
                    e.dataTransfer.dropEffect = 'move';
                });
                
                button.addEventListener('drop', (e) => {
                    e.preventDefault();
                    if (draggedElement && draggedElement !== button) {
                        const allButtons = Array.from(layerGrid.children);
                        const draggedIndex = allButtons.indexOf(draggedElement);
                        const targetIndex = allButtons.indexOf(button);
                        
                        if (draggedIndex < targetIndex) {
                            layerGrid.insertBefore(draggedElement, button.nextSibling);
                        } else {
                            layerGrid.insertBefore(draggedElement, button);
                        }
                    }
                });
            });
        }
        
        function toggleLockIcon(button) {
            const icon = button.querySelector('i');
            button.classList.add('animating');
            
            if (icon.classList.contains('ri-lock-unlock-line')) {
                icon.className = 'ri-lock-fill';
            } else {
                icon.className = 'ri-lock-unlock-line';
            }
            
            setTimeout(() => {
                button.classList.remove('animating');
            }, 100);
        }
        
        function sortLayerButtons() {
            const layerGrid = document.getElementById('layer-grid');
            const buttons = Array.from(layerGrid.children);
            
            const sortToggleBtn = document.getElementById('layer-sort-toggle');
            const icon = sortToggleBtn.querySelector('i');
            
            sortToggleBtn.classList.add('sorting');
            
            if (!isLayerSortedByActive) {
                const activeButtons = buttons.filter(btn => btn.classList.contains('active'));
                const inactiveButtons = buttons.filter(btn => !btn.classList.contains('active'));
                
                layerGrid.innerHTML = '';
                activeButtons.forEach(btn => layerGrid.appendChild(btn));
                inactiveButtons.forEach(btn => layerGrid.appendChild(btn));
                
                icon.className = 'ri-align-justify';
                isLayerSortedByActive = true;
            } else {
                const originalOrder = [
                    'Texture', 'Heightmap', 'Biomes', 'Cells', 'Grid', 'Coordinates',
                    'Wind Rose', 'Rivers', 'Relief', 'Religions', 'Cultures', 'States',
                    'Provinces', 'Zones', 'Borders', 'Routes', 'Temperature', 'Population',
                    'Ice', 'Precipitation', 'Emblems', 'Labels', 'Icons', 'Military',
                    'Markers', 'Rulers', 'Scale Bar'
                ];
                
                layerGrid.innerHTML = '';
                originalOrder.forEach(layerName => {
                    const button = buttons.find(btn => btn.textContent.trim() === layerName);
                    if (button) layerGrid.appendChild(button);
                });
                
                icon.className = 'ri-sort-desc';
                isLayerSortedByActive = false;
            }
            
            // Reinitialize drag and drop after sorting
            setTimeout(() => {
                sortToggleBtn.classList.remove('sorting');
                initializeDragAndDrop();
            }, 100);
        }
        
        function togglePanelVisibility() {
            const panel = document.getElementById('control-panel');
            const visibilityToggle = document.getElementById('visibility-toggle');
            const hideBtn = document.getElementById('hide-panel-btn');
            const icon = visibilityToggle.querySelector('i');
            
            // If in sidebar mode, exit sidebar mode first
            if (panel.classList.contains('sidebar-mode')) {
                panel.classList.remove('sidebar-mode');
                // Reset sidebar button state
                const toggleSidebarBtn = document.getElementById('toggle-sidebar-btn');
                const sidebarIcon = toggleSidebarBtn.querySelector('i');
                sidebarIcon.className = 'ri-sidebar-fold-line';
                toggleSidebarBtn.title = 'Attach to Sidebar';
            }
            
            panel.classList.toggle('collapsed');
            
            if (panel.classList.contains('collapsed')) {
                // Snap to sticky top-left
                panel.style.left = '';
                panel.style.top = '';
            } else {
                // Always reset to initial position
                panel.style.left = '2rem';
                panel.style.top = '2rem';
            }
            
            if (panel.classList.contains('collapsed')) {
                icon.className = 'ri-eye-line';
                visibilityToggle.title = 'Show Panel';
            } else {
                icon.className = 'ri-eye-off-line';
                visibilityToggle.title = 'Hide Panel';
            }
        }
        
        function toggleSidebarMode() {
            const panel = document.getElementById('control-panel');
            const toggleSidebarBtn = document.getElementById('toggle-sidebar-btn');
            const icon = toggleSidebarBtn.querySelector('i');
            
            // Remove collapsed state if active
            if (panel.classList.contains('collapsed')) {
                panel.classList.remove('collapsed');
            }
            
            panel.classList.toggle('sidebar-mode');
            
            if (panel.classList.contains('sidebar-mode')) {
                // Sidebar mode: attach to left side
                icon.className = 'ri-sidebar-unfold-line';
                toggleSidebarBtn.title = 'Detach from Sidebar';
            } else {
                // Normal mode: return to floating position
                icon.className = 'ri-sidebar-fold-fill';
                toggleSidebarBtn.title = 'Attach to Sidebar';
                
                // Reset to initial position
                panel.style.left = '2rem';
                panel.style.top = '2rem';
            }
        }
        
        document.addEventListener('DOMContentLoaded', () => {
            initializeTooltips();
            initializeDragAndDrop();
            
            const tooltipToggle = document.getElementById('tooltip-toggle');
            // Set initial icon state based on cached preference
            const icon = tooltipToggle.querySelector('i');
            icon.className = tooltipsEnabled ? 'ri-information-off-line' : 'ri-information-line';
            
            tooltipToggle.addEventListener('click', () => {
                tooltipsEnabled = !tooltipsEnabled;
                localStorage.setItem('tooltipsEnabled', tooltipsEnabled);
                icon.className = tooltipsEnabled ? 'ri-information-off-line' : 'ri-information-line';
            });
            
            const layerSortToggle = document.getElementById('layer-sort-toggle');
            layerSortToggle.addEventListener('click', sortLayerButtons);
            
            const hideBtn = document.getElementById('hide-panel-btn');
            const visibilityToggle = document.getElementById('visibility-toggle');
            
            hideBtn.addEventListener('click', togglePanelVisibility);
            visibilityToggle.addEventListener('click', togglePanelVisibility);
            
            const toggleSidebarBtn = document.getElementById('toggle-sidebar-btn');
            toggleSidebarBtn.addEventListener('click', toggleSidebarMode);
            
            const lockButtons = document.querySelectorAll('.slider-prefix-icon.lock-toggle');
            lockButtons.forEach(button => {
                button.addEventListener('click', () => {
                    toggleLockIcon(button);
                });
            });
            
            const panel = document.getElementById('control-panel');
            const dragHandle = document.getElementById('drag-handle');
            let isPanelDragging = false;
            let offsetX, offsetY;

            dragHandle.addEventListener('mousedown', (e) => {
                if (panel.classList.contains('collapsed') || panel.classList.contains('sidebar-mode')) return;
                isPanelDragging = true;
                offsetX = e.clientX - panel.offsetLeft;
                offsetY = e.clientY - panel.offsetTop;
                panel.style.transition = 'none';
                document.body.style.userSelect = 'none';
            });

            // Panel drag safe zone
            document.addEventListener('mousemove', (e) => {
                if (!isPanelDragging) return;
                
                let newLeft = e.clientX - offsetX;
                let newTop = e.clientY - offsetY;
                
                const panelRect = panel.getBoundingClientRect();
                const panelWidth = panelRect.width;
                const panelHeight = panelRect.height;
                
                const viewportWidth = window.innerWidth;
                const viewportHeight = window.innerHeight;
                
                const bufferX = Math.min(panelWidth * 0.5, 250);
                const bufferY = 50;
                
                if (newLeft < -bufferX) {
                    newLeft = -bufferX;
                }
                
                if (newLeft + panelWidth > viewportWidth + bufferX) {
                    newLeft = viewportWidth + bufferX - panelWidth;
                }
                
                if (newTop < 0) {
                    newTop = 0;
                }
                
                if (newTop + 32 > viewportHeight) {
                    newTop = viewportHeight - 32;
                }
                
                panel.style.left = `${newLeft}px`;
                panel.style.top = `${newTop}px`;
            });

            document.addEventListener('mouseup', () => {
                isPanelDragging = false;
                panel.style.transition = '';
                document.body.style.userSelect = '';
            });

            const navItems = document.querySelectorAll('.panel-nav-item');
            const tabPanes = document.querySelectorAll('.tab-pane');

            navItems.forEach(item => {
                item.addEventListener('click', () => {
                    navItems.forEach(i => i.classList.remove('active'));
                    tabPanes.forEach(p => p.classList.remove('active'));

                    item.classList.add('active');
                    const targetPane = document.getElementById(item.dataset.target);
                    if (targetPane) {
                        targetPane.classList.add('active');
                    }
                });
            });

            const defaultLayerState = [
                'Rivers', 'States', 'Borders', 'Routes', 'Ice', 'Labels', 'Icons', 'Scale Bar'
            ];
            
            const presetConfigs = {
                'Political map': defaultLayerState,
                'Cultural map': defaultLayerState,
                'Religions map': defaultLayerState,
                'Provinces map': defaultLayerState,
                'Biomes map': defaultLayerState,
                'Heightmap': defaultLayerState,
                'Physical map': defaultLayerState,
                'Places of interest': defaultLayerState,
                'Military map': defaultLayerState,
                'Emblems': defaultLayerState,
                'Pure landmass': defaultLayerState
            };
            
            const layerButtons = document.querySelectorAll('#tab-layers .grid-3-col .btn');
            const savePresetBtn = document.getElementById('save-preset-btn');
            
            function checkLayerState() {
                const activeLayers = Array.from(layerButtons)
                    .filter(btn => btn.classList.contains('active'))
                    .map(btn => btn.textContent.trim());
                
                const isDefaultState = defaultLayerState.length === activeLayers.length &&
                    defaultLayerState.every(layer => activeLayers.includes(layer));
                
                savePresetBtn.style.display = isDefaultState ? 'none' : 'flex';
                updateCustomPresetOption();
                
                if (isLayerSortedByActive) {
                    sortLayerButtons();
                }
            }
            
            function getNextCustomPresetNumber() {
                const presetSelect = document.getElementById('layers-preset');
                const customOptions = presetSelect.querySelectorAll('option[data-custom="true"]');
                const customNumbers = Array.from(customOptions)
                    .map(option => {
                        const match = option.text.match(/\(My Custom Preset (\d+)\)/);
                        return match ? parseInt(match[1]) : 0;
                    })
                    .filter(num => num > 0);
                
                return customNumbers.length > 0 ? Math.max(...customNumbers) + 1 : 1;
            }
            
            function getCurrentLayerState() {
                return Array.from(layerButtons)
                    .filter(btn => btn.classList.contains('active'))
                    .map(btn => btn.textContent.trim());
            }
            
            function applyLayerState(layerState) {
                layerButtons.forEach(btn => {
                    const layerName = btn.textContent.trim();
                    if (layerState.includes(layerName)) {
                        btn.classList.add('active');
                    } else {
                        btn.classList.remove('active');
                    }
                });
            }
            
            function saveCurrentStateToPreset(presetName) {
                const currentState = getCurrentLayerState();
                presetConfigs[presetName] = [...currentState];
            }
            
            function updateCustomPresetOption() {
                const presetSelect = document.getElementById('layers-preset');
                const customOption = presetSelect.querySelector('option[data-custom="true"]');
                
                if (customOption) {
                    customOption.remove();
                }
                
                const activeLayers = Array.from(layerButtons)
                    .filter(btn => btn.classList.contains('active'))
                    .map(btn => btn.textContent.trim());
                
                const isDefaultState = defaultLayerState.length === activeLayers.length &&
                    defaultLayerState.every(layer => activeLayers.includes(layer));
                
                if (!isDefaultState) {
                    const nextNumber = getNextCustomPresetNumber();
                    const newCustomOption = document.createElement('option');
                    newCustomOption.text = `(My Custom Preset ${nextNumber})`;
                    newCustomOption.style.color = 'var(--text-secondary)';
                    newCustomOption.setAttribute('data-custom', 'true');
                    newCustomOption.setAttribute('data-unsaved', 'true');
                    presetSelect.add(newCustomOption);
                    
                    presetSelect.selectedIndex = presetSelect.options.length - 1;
                }
            }
            
            const toggleButtons = document.querySelectorAll('.tab-pane .btn:not(.group-btn):not(.danger-variant)');
            toggleButtons.forEach(button => {
                button.addEventListener('click', () => {
                    if (button.textContent.trim() === 'Configure World' || 
                        button.textContent.trim() === 'Reset to defaults' ||
                        button.textContent.trim() === 'Init Google Translate') {
                        return;
                    }
                    
                    // Don't toggle Tools tab buttons
                    if (button.closest('#tab-tools')) {
                        return;
                    }
                    
                    button.classList.toggle('active');
                    
                    if (button.closest('#tab-layers .grid-3-col')) {
                        checkLayerState();
                        
                        const presetSelect = document.getElementById('layers-preset');
                        const selectedPreset = presetSelect.options[presetSelect.selectedIndex].text;
                        if (presetSelect.options[presetSelect.selectedIndex].hasAttribute('data-custom')) {
                            saveCurrentStateToPreset(selectedPreset);
                        }
                    }
                });
            });
            
            checkLayerState();

            const buttonGroups = document.querySelectorAll('[data-toggle-group]');
            buttonGroups.forEach(group => {
                const buttons = group.querySelectorAll('.btn');
                buttons.forEach(button => {
                    button.addEventListener('click', () => {
                        buttons.forEach(btn => btn.classList.remove('active'));
                        button.classList.add('active');
                    });
                });
            });

            function setupDropdownNavigation(selectId, prevBtnId, nextBtnId, onChangeCallback = null) {
                const select = document.getElementById(selectId);
                const prevBtn = document.getElementById(prevBtnId);
                const nextBtn = document.getElementById(nextBtnId);
                
                if (!select || !prevBtn || !nextBtn) return;
                
                prevBtn.addEventListener('click', () => {
                    const currentIndex = select.selectedIndex;
                    const newIndex = currentIndex > 0 ? currentIndex - 1 : select.options.length - 1;
                    select.selectedIndex = newIndex;
                    select.dispatchEvent(new Event('change'));
                });
                
                nextBtn.addEventListener('click', () => {
                    const currentIndex = select.selectedIndex;
                    const newIndex = currentIndex < select.options.length - 1 ? currentIndex + 1 : 0;
                    select.selectedIndex = newIndex;
                    select.dispatchEvent(new Event('change'));
                });
                
                if (onChangeCallback) {
                    select.addEventListener('change', onChangeCallback);
                }
            }
            
            const presetSelect = document.getElementById('layers-preset');
            setupDropdownNavigation('layers-preset', 'preset-prev', 'preset-next', () => {
                const selectedPreset = presetSelect.options[presetSelect.selectedIndex].text;
                
                if (presetSelect.options[presetSelect.selectedIndex].hasAttribute('data-custom')) {
                    if (presetConfigs[selectedPreset]) {
                        applyLayerState(presetConfigs[selectedPreset]);
                    }
                } else {
                    if (presetConfigs[selectedPreset]) {
                        applyLayerState(presetConfigs[selectedPreset]);
                    }
                }
                
                updateUIAfterPresetChange();
            });
            
            function updateUIAfterPresetChange() {
                const activeLayers = Array.from(layerButtons)
                    .filter(btn => btn.classList.contains('active'))
                    .map(btn => btn.textContent.trim());
                
                const isDefaultState = defaultLayerState.length === activeLayers.length &&
                    defaultLayerState.every(layer => activeLayers.includes(layer));
                
                const isCustomPresetSelected = presetSelect.options[presetSelect.selectedIndex].hasAttribute('data-custom');
                
                savePresetBtn.style.display = (isDefaultState || isCustomPresetSelected) ? 'none' : 'flex';
            }

            const savePresetInput = document.getElementById('save-preset-input');
            const presetNameInput = document.getElementById('preset-name-input');
            const savePresetConfirm = document.getElementById('save-preset-confirm');
            const savePresetCancel = document.getElementById('save-preset-cancel');

            savePresetBtn.addEventListener('click', () => {
                savePresetBtn.style.display = 'none';
                savePresetInput.style.display = 'flex';
                presetNameInput.focus();
            });

            savePresetCancel.addEventListener('click', () => {
                savePresetInput.style.display = 'none';
                savePresetBtn.style.display = 'flex';
                presetNameInput.value = '';
                
                const unsavedOption = presetSelect.querySelector('option[data-unsaved="true"]');
                if (unsavedOption) {
                    unsavedOption.remove();
                }
            });

            savePresetConfirm.addEventListener('click', () => {
                let presetName = presetNameInput.value.trim();
                
                if (!presetName) {
                    const nextNumber = getNextCustomPresetNumber();
                    presetName = `(My Custom Preset ${nextNumber})`;
                }
                
                const existingUnsavedOption = presetSelect.querySelector('option[data-unsaved="true"]');
                if (existingUnsavedOption) {
                    existingUnsavedOption.remove();
                }
                
                saveCurrentStateToPreset(presetName);
                
                const newOption = document.createElement('option');
                newOption.text = presetName;
                newOption.setAttribute('data-custom', 'true');
                presetSelect.add(newOption);
                
                presetSelect.selectedIndex = presetSelect.options.length - 1;
                
                savePresetInput.style.display = 'none';
                savePresetBtn.style.display = 'flex';
                presetNameInput.value = '';
                
                updateUIAfterPresetChange();
            });

            presetNameInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    savePresetConfirm.click();
                }
            });

            presetNameInput.addEventListener('keydown', (e) => {
                if (e.key === 'Escape') {
                    savePresetCancel.click();
                }
            });

            [
                ['style-preset', 'style-prev', 'style-next'],
                ['select-element', 'element-prev', 'element-next'],
                ['heightmap-select', 'heightmap-prev', 'heightmap-next'],
                ['cultures-select', 'cultures-prev', 'cultures-next'],
                ['onload-select', 'onload-prev', 'onload-next'],
                ['voice-select', 'voice-prev', 'voice-next'],
                ['emblem-select', 'emblem-prev', 'emblem-next'],
                ['state-labels-select', 'state-labels-prev', 'state-labels-next']
            ].forEach(args => setupDropdownNavigation(...args));
            
            const themeSelect = document.getElementById('ui-theme');
            setupDropdownNavigation('ui-theme', 'theme-prev', 'theme-next', () => {
                const selectedTheme = themeSelect.options[themeSelect.selectedIndex].text;
                applyTheme(selectedTheme);
            });
            
            function applyTheme(themeName) {
                const body = document.body;
                body.removeAttribute('data-theme');
                
                switch(themeName) {
                    case 'Dark Mode':
                        body.setAttribute('data-theme', 'dark-mode');
                        break;
                    case 'Light Mode':
                        body.setAttribute('data-theme', 'light-mode');
                        break;
                    case 'Legacy':
                        body.setAttribute('data-theme', 'legacy');
                        break;
                    case 'Default':
                    default:
                        break;
                }
                
                const opacitySlider = document.getElementById('opacity-amount');
                if (opacitySlider) {
                    updatePanelOpacity(opacitySlider.value);
                }
                
                const allSliders = document.querySelectorAll('input[type="range"]');
                allSliders.forEach(slider => {
                    updateSliderFill(slider);
                });
            }
            
            function updatePanelBlur(blurValue) {
                const panel = document.getElementById('control-panel');
                const sliderValue = document.querySelector('#blur-amount + .slider-value');
                
                panel.style.backdropFilter = 'none';
                panel.offsetHeight;
                panel.style.backdropFilter = `blur(${blurValue}px)`;
                
                sliderValue.textContent = `${blurValue}px`;
            }
            
            function updatePanelOpacity(opacityValue) {
                const panel = document.getElementById('control-panel');
                const sliderValue = document.querySelector('#opacity-amount + .slider-value');
                
                const opacityDecimal = opacityValue / 100;
                
                const bgPrimaryColor = getComputedStyle(document.body).getPropertyValue('--bg-primary').trim();
                
                let rgbColor;
                if (bgPrimaryColor.startsWith('#')) {
                    const hex = bgPrimaryColor.replace('#', '');
                    const r = parseInt(hex.substr(0, 2), 16);
                    const g = parseInt(hex.substr(2, 2), 16);
                    const b = parseInt(hex.substr(4, 2), 16);
                    rgbColor = `${r}, ${g}, ${b}`;
                } else {
                    const rgbMatch = bgPrimaryColor.match(/rgb\((\d+),\s*(\d+),\s*(\d+)\)/);
                    if (rgbMatch) {
                        rgbColor = `${rgbMatch[1]}, ${rgbMatch[2]}, ${rgbMatch[3]}`;
                    } else {
                        rgbColor = '26, 31, 46';
                    }
                }
                
                panel.style.background = `rgba(${rgbColor}, ${opacityDecimal})`;
                sliderValue.textContent = `${opacityValue}%`;
            }

            const vignetteToggle = document.getElementById('vignette-toggle');
            vignetteToggle.addEventListener('click', () => {
                vignetteToggle.classList.toggle('active');
            });

            const azgaarToggle = document.getElementById('azgaar-toggle');
            azgaarToggle.addEventListener('click', () => {
                azgaarToggle.classList.toggle('active');
            });

            const blurSlider = document.getElementById('blur-amount');
            blurSlider.addEventListener('input', () => {
                updatePanelBlur(blurSlider.value);
                updateSliderFill(blurSlider);
            });

            const opacitySlider = document.getElementById('opacity-amount');
            opacitySlider.addEventListener('input', () => {
                updatePanelOpacity(opacitySlider.value);
                updateSliderFill(opacitySlider);
            });

            function updateSliderFill(slider) {
                const value = (slider.value - slider.min) / (slider.max - slider.min) * 100;
                const accentColor = getComputedStyle(document.body).getPropertyValue('--accent-primary').trim();
                const accentSecondary = getComputedStyle(document.body).getPropertyValue('--accent-secondary').trim();
                slider.style.background = `linear-gradient(to right, ${accentColor} 0%, ${accentColor} ${value}%, ${accentSecondary} ${value}%, ${accentSecondary} 100%)`;
            }

            const allSliders = document.querySelectorAll('input[type="range"]');
            allSliders.forEach(slider => {
                updateSliderFill(slider);
                
                slider.addEventListener('input', () => {
                    updateSliderFill(slider);
                    const sliderValue = slider.nextElementSibling;
                    if (sliderValue && sliderValue.classList.contains('slider-value')) {
                        if (slider.step && parseFloat(slider.step) < 1) {
                            sliderValue.textContent = slider.value.replace('.', ',');
                        }
                    }
                });
                
                const sliderValue = slider.nextElementSibling;
                if (sliderValue && sliderValue.classList.contains('slider-value')) {
                    const hasDecimalStep = slider.step && parseFloat(slider.step) < 1;
                    if (hasDecimalStep) {
                        makeDecimalSliderValueEditable(slider, sliderValue);
                        sliderValue.textContent = slider.value.replace('.', ',');
                    } else {
                        makeSliderValueEditable(slider, sliderValue);
                    }
                }
            });
            
            function makeSliderValueEditable(slider, valueElement) {
                valueElement.addEventListener('click', () => {
                    const currentValue = slider.value;
                    const input = document.createElement('input');
                    input.type = 'text';
                    input.value = currentValue;
                    input.inputMode = 'numeric';
                    input.style.cssText = `
                        width: ${valueElement.offsetWidth}px;
                        height: ${valueElement.offsetHeight}px;
                        border: 1px solid var(--accent-primary);
                        border-radius: 3px;
                        background: var(--bg-secondary);
                        color: var(--text-primary);
                        font-family: 'Inter', sans-serif;
                        font-size: 0.9rem;
                        text-align: right;
                        padding: 2px 6px;
                        outline: none;
                    `;
                    
                    valueElement.style.display = 'none';
                    valueElement.parentNode.insertBefore(input, valueElement.nextSibling);
                    input.focus();
                    input.select();
                    
                    const handleInput = () => {
                        let filteredValue = input.value.replace(/[^0-9-]/g, '');
                        
                        if (filteredValue.startsWith('-') && filteredValue.indexOf('-', 1) !== -1) {
                            filteredValue = filteredValue.replace(/-/g, '');
                            filteredValue = '-' + filteredValue;
                        }
                        
                        input.value = filteredValue;
                        
                        const newValue = parseInt(filteredValue);
                        if (!isNaN(newValue) && newValue >= parseInt(slider.min) && newValue <= parseInt(slider.max)) {
                            slider.value = newValue;
                            updateSliderFill(slider);
                            
                            if (slider.id === 'points-number') {
                                valueElement.textContent = newValue + 'K';
                            } else if (slider.id === 'opacity-amount') {
                                valueElement.textContent = newValue + '%';
                            } else if (slider.id === 'blur-amount') {
                                valueElement.textContent = newValue + 'px';
                            } else {
                                valueElement.textContent = newValue;
                            }
                        }
                    };
                    
                    const handleBlur = () => {
                        handleInput();
                        input.remove();
                        valueElement.style.display = '';
                    };
                    
                    const handleKeyDown = (e) => {
                        if (e.key === 'Enter') {
                            handleInput();
                            input.remove();
                            valueElement.style.display = '';
                        } else if (e.key === 'Escape') {
                            input.remove();
                            valueElement.style.display = '';
                        }
                    };
                    
                    input.addEventListener('input', handleInput);
                    input.addEventListener('blur', handleBlur);
                    input.addEventListener('keydown', handleKeyDown);
                });
            }

            function makeDecimalSliderValueEditable(slider, valueElement) {
                valueElement.addEventListener('click', () => {
                    const currentValue = slider.value.replace('.', ',');
                    const input = document.createElement('input');
                    input.type = 'text';
                    input.value = currentValue;
                    input.inputMode = 'decimal';
                    input.style.cssText = `
                        width: ${valueElement.offsetWidth}px;
                        height: ${valueElement.offsetHeight}px;
                        border: 1px solid var(--accent-primary);
                        border-radius: 3px;
                        background: var(--bg-secondary);
                        color: var(--text-primary);
                        font-family: 'Inter', sans-serif;
                        font-size: 0.9rem;
                        text-align: right;
                        padding: 2px 6px;
                        outline: none;
                    `;
                    valueElement.style.display = 'none';
                    valueElement.parentNode.insertBefore(input, valueElement.nextSibling);
                    input.focus();
                    input.select();
                    
                    const handleInput = () => {
                        let filteredValue = input.value.replace(/[^0-9,-]/g, '');
                        const decimalCount = (filteredValue.match(/,/g) || []).length;
                        if (decimalCount > 1) {
                            filteredValue = filteredValue.replace(/,+$/, '');
                        }
                        if (filteredValue.startsWith('-') && filteredValue.indexOf('-', 1) !== -1) {
                            filteredValue = filteredValue.replace(/-/g, '');
                            filteredValue = '-' + filteredValue;
                        }
                        input.value = filteredValue;
                        const parseValue = filteredValue.replace(',', '.');
                        const newValue = parseFloat(parseValue);
                        if (!isNaN(newValue) && newValue >= parseFloat(slider.min) && newValue <= parseFloat(slider.max)) {
                            slider.value = parseValue;
                            updateSliderFill(slider);
                            const displayValue = slider.value.replace('.', ',');
                            valueElement.textContent = displayValue;
                        }
                    };
                    const handleBlur = () => {
                        handleInput();
                        input.remove();
                        valueElement.style.display = '';
                    };
                    const handleKeyDown = (e) => {
                        if (e.key === 'Enter') {
                            handleInput();
                            input.remove();
                            valueElement.style.display = '';
                        } else if (e.key === 'Escape') {
                            input.remove();
                            valueElement.style.display = '';
                        }
                    };
                    input.addEventListener('input', handleInput);
                    input.addEventListener('blur', handleBlur);
                    input.addEventListener('keydown', handleKeyDown);
                });
            }

            const diceButtons = document.querySelectorAll('.dice-btn');
            diceButtons.forEach(button => {
                addDiceAnimation(button);
            });
            
            const randomizeEraBtn = document.getElementById('randomizeEraBtn');
            const eraInput = randomizeEraBtn.previousElementSibling;
            
            const eraNames = [
                'Macking Era', 'Golden Age', 'Dark Ages', 'Renaissance', 'Industrial Revolution'
            ];
            
            randomizeEraBtn.addEventListener('click', () => {
                const currentEra = eraInput.value;
                let newEra;
                do {
                    newEra = eraNames[Math.floor(Math.random() * eraNames.length)];
                } while (newEra === currentEra && eraNames.length > 1);
                
                eraInput.value = newEra;
            });

            // Fit to screen toggle button
            const fitToScreenBtn = document.getElementById('fitToScreenBtn');
            fitToScreenBtn.addEventListener('click', () => {
                fitToScreenBtn.classList.toggle('toggled');
            });

            // Background zoom functionality
            let currentZoom = 1;
            let isZooming = false;
            let zoomStartY = 0;
            let zoomStartScale = 1;
            
            // Mouse wheel zoom
            document.addEventListener('wheel', (e) => {
                const panel = document.getElementById('control-panel');
                if (panel.contains(e.target)) return;
                e.preventDefault();
                
                let delta = e.deltaY > 0 ? 0.9 : 1.1;
                let newZoom = currentZoom * delta;
                
                if (newZoom < 1) {
                    document.body.style.backgroundSize = 'cover';
                    document.body.style.backgroundPosition = 'center';
                    currentZoom = 1;
                    return;
                }
                newZoom = Math.min(5, newZoom);
                
                if (newZoom !== currentZoom) {
                    const rect = document.body.getBoundingClientRect();
                    const mouseX = e.clientX - rect.left;
                    const mouseY = e.clientY - rect.top;
                    
                    zoomToPoint(mouseX, mouseY, newZoom);
                }
            });
            
            // Touch zoom for mobile
            let initialDistance = 0;
            let initialZoom = 1;
            
            document.addEventListener('touchstart', (e) => {
                if (e.touches.length === 2) {
                    initialDistance = Math.hypot(
                        e.touches[0].clientX - e.touches[1].clientX,
                        e.touches[0].clientY - e.touches[1].clientY
                    );
                    initialZoom = currentZoom;
                }
            });
            
            document.addEventListener('touchmove', (e) => {
                if (e.touches.length === 2) {
                    e.preventDefault();
                    
                    const currentDistance = Math.hypot(
                        e.touches[0].clientX - e.touches[1].clientX,
                        e.touches[0].clientY - e.touches[1].clientY
                    );
                    
                    let scale = currentDistance / initialDistance;
                    let newZoom = initialZoom * scale;
                    
                    if (newZoom < 1) {
                        document.body.style.backgroundSize = 'cover';
                        document.body.style.backgroundPosition = 'center';
                        currentZoom = 1;
                        return;
                    }
                    newZoom = Math.min(5, newZoom);
                    
                    if (newZoom !== currentZoom) {
                        const rect = document.body.getBoundingClientRect();
                        const centerX = (e.touches[0].clientX + e.touches[1].clientX) / 2 - rect.left;
                        const centerY = (e.touches[0].clientY + e.touches[1].clientY) / 2 - rect.top;
                        
                        zoomToPoint(centerX, centerY, newZoom);
                    }
                }
            });
            
            function zoomToPoint(x, y, zoom) {
                const body = document.body;
                const rect = body.getBoundingClientRect();
                
                const newSize = `${100 * zoom}%`;
                
                const xPercent = (x / rect.width) * 100;
                const yPercent = (y / rect.height) * 100;
                
                const xOffset = (xPercent - 50) * (1 - 1/zoom);
                const yOffset = (yPercent - 50) * (1 - 1/zoom);
                
                const newPosition = `${50 + xOffset}% ${50 + yOffset}%`;
                
                body.style.backgroundSize = newSize;
                body.style.backgroundPosition = newPosition;
                currentZoom = zoom;
            }
            
            const resetZoomBtn = document.querySelector('.search-btn');
            resetZoomBtn.addEventListener('click', () => {
                const body = document.body;
                body.style.backgroundSize = 'cover';
                body.style.backgroundPosition = 'center';
                currentZoom = 1;
            });

            // New Map button changes background image
            const newMapBtn = document.getElementById('new-map-btn');
            newMapBtn.addEventListener('click', () => {
                const currentBg = document.body.style.backgroundImage.replace(/^url\(['"]?|['"]?\)$/g, '').replace(/url\(['"]?|['"]?\)/g, '').replace(/['"]/g, '');
                const availableImages = BACKGROUND_IMAGES.length > 1 ? BACKGROUND_IMAGES.filter(img => !currentBg || img !== currentBg) : BACKGROUND_IMAGES;
                const newImg = availableImages[Math.floor(Math.random() * availableImages.length)];
                setTimeout(() => {
                    document.body.style.backgroundImage = `url('${newImg}')`;
                }, 500);
            });

            // Set a random background image on page load
            (function setRandomBackgroundOnLoad() {
                let newImg;
                newImg = BACKGROUND_IMAGES[Math.floor(Math.random() * BACKGROUND_IMAGES.length)];
                document.body.style.backgroundImage = `url('${newImg}')`;
            })();

            let mapHistory = [];
            let mapHistoryIndex = -1;

            function setBackgroundImage(url, addToHistory = true) {
                document.body.style.backgroundImage = `url('${url}')`;
                if (addToHistory) {
                    if (mapHistory.length === 0 || mapHistory[mapHistory.length - 1] !== url) {
                        mapHistory.push(url);
                        if (mapHistory.length > 10) mapHistory.shift();
                    }
                    mapHistoryIndex = mapHistory.length - 1;
                }
            }

            (function setRandomBackgroundOnLoad() {
                const newImg = BACKGROUND_IMAGES[Math.floor(Math.random() * BACKGROUND_IMAGES.length)];
                setBackgroundImage(newImg);
            })();

            newMapBtn.addEventListener('click', () => {
                const currentBg = document.body.style.backgroundImage.replace(/^url\(['"]?|['"]?\)$/g, '').replace(/url\(['"]?|['"]?\)/g, '').replace(/['"]/g, '');
                const availableImages = BACKGROUND_IMAGES.length > 1 ? BACKGROUND_IMAGES.filter(img => !currentBg || img !== currentBg) : BACKGROUND_IMAGES;
                const newImg = availableImages[Math.floor(Math.random() * availableImages.length)];
                setTimeout(() => {
                    setBackgroundImage(newImg);
                }, 500);
            });

            const backBtn = document.getElementById('back-btn');
            backBtn.addEventListener('click', () => {
                if (mapHistory.length > 1 && mapHistoryIndex > 0) {
                    mapHistoryIndex--;
                    setBackgroundImage(mapHistory[mapHistoryIndex], false);
                }
            });

            function manageMobileFooter() {
                const panelContent = document.querySelector('.panel-content');
                const panelFooter = document.querySelector('.panel-footer');
                const isMobile = window.innerWidth <= 768;
                
                if (isMobile) {
                    if (!panelContent.contains(panelFooter)) {
                        panelContent.appendChild(panelFooter);
                    }
                } else {
                    const panelWrapper = document.querySelector('.panel-wrapper');
                    if (panelContent.contains(panelFooter)) {
                        panelWrapper.appendChild(panelFooter);
                    }
                }
            }

            manageMobileFooter();
            window.addEventListener('resize', manageMobileFooter);
        });
    </script>
</body>
</html>